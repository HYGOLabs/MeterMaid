<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Meter ‚ö°">
  <title>LADWP Meter Reader ‚ö°</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #111827;
      color: white;
      min-height: 100vh;
      padding: 16px;
      padding-top: env(safe-area-inset-top, 16px);
      padding-bottom: calc(env(safe-area-inset-bottom, 16px) + 20px);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .header h1 { font-size: 1.25rem; }
    .header-buttons { display: flex; gap: 8px; }
    .header-buttons button {
      background: #374151;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 1.1rem;
      cursor: pointer;
    }
    .datetime-section {
      background: #1f2937;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .datetime-section label {
      font-size: 0.85rem;
      color: #9ca3af;
      white-space: nowrap;
    }
    .datetime-section input {
      flex: 1;
      background: #374151;
      border: none;
      border-radius: 6px;
      padding: 8px 10px;
      color: white;
      font-size: 0.9rem;
    }
    .datetime-section button {
      background: #4b5563;
      border: none;
      border-radius: 6px;
      padding: 8px 10px;
      color: white;
      font-size: 0.75rem;
      cursor: pointer;
      white-space: nowrap;
    }
    .section {
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .section.delivered { background: rgba(30, 58, 138, 0.3); }
    .section.received { background: rgba(20, 83, 45, 0.3); }
    .section.net { background: rgba(120, 53, 15, 0.3); }
    .section.totals { background: rgba(88, 28, 135, 0.3); }
    .section h2 {
      font-size: 0.8rem;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .section.delivered h2 { color: #60a5fa; }
    .section.received h2 { color: #4ade80; }
    .section.net h2 { color: #fb923c; }
    .section.totals h2 { color: #c084fc; }
    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
    }
    .input-grid.two-col {
      grid-template-columns: 1fr 1fr;
    }
    .input-group label {
      display: block;
      font-size: 0.65rem;
      color: #9ca3af;
      margin-bottom: 2px;
      text-align: center;
    }
    .input-group .code {
      font-weight: bold;
      color: #e5e7eb;
    }
    .input-group input {
      width: 100%;
      background: #1f2937;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 10px 4px;
      font-size: 1rem;
      text-align: center;
      color: white;
    }
    .section.received .input-group input { border-color: #22c55e; }
    .section.net .input-group input { border-color: #f97316; }
    .section.totals .input-group input { border-color: #a855f7; }
    input[type="text"].notes {
      width: 100%;
      background: #1f2937;
      border: 1px solid #374151;
      border-radius: 8px;
      padding: 10px;
      color: white;
      font-size: 0.9rem;
      margin-bottom: 12px;
    }
    .save-btn {
      width: 100%;
      background: #2563eb;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 1.2rem;
      font-weight: bold;
      color: white;
      cursor: pointer;
    }
    .save-btn:active { background: #1d4ed8; }
    .status {
      text-align: center;
      font-size: 1rem;
      margin-top: 10px;
      min-height: 1.5em;
    }
    .validation {
      background: #1f2937;
      border-radius: 8px;
      padding: 10px;
      margin-top: 12px;
      font-size: 0.75rem;
    }
    .validation .row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
    }
    .validation .pass { color: #4ade80; }
    .validation .fail { color: #f87171; }
    .settings-panel, .history-panel {
      background: #1f2937;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }
    .settings-panel h2, .history-panel h2 {
      font-weight: bold;
      margin-bottom: 12px;
    }
    .rate-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 12px;
    }
    .rate-grid label {
      font-size: 0.7rem;
      color: #9ca3af;
    }
    .rate-grid input {
      width: 100%;
      background: #374151;
      border: none;
      border-radius: 6px;
      padding: 8px;
      text-align: center;
      color: white;
    }
    .settings-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .settings-buttons button {
      flex: 1;
      min-width: 45%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      color: white;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .settings-buttons .save-rates { background: #2563eb; }
    .settings-buttons .export { background: #15803d; }
    .clear-btn {
      width: 100%;
      margin-top: 8px;
      padding: 10px;
      background: #991b1b;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.85rem;
      cursor: pointer;
    }
    .history-item {
      background: #111827;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .history-item .date-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    .history-item .date { font-weight: bold; }
    .history-item .time { font-size: 0.75rem; color: #9ca3af; }
    .history-item .delete-btn {
      background: none;
      border: none;
      color: #f87171;
      font-size: 1rem;
      cursor: pointer;
      padding: 0 8px;
    }
    .history-item .codes-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      font-size: 0.8rem;
      margin-bottom: 8px;
    }
    .history-item .codes-grid > div {
      background: #1f2937;
      padding: 6px 8px;
      border-radius: 6px;
    }
    .history-item .label { color: #9ca3af; font-size: 0.7rem; }
    .history-item .blue { color: #60a5fa; }
    .history-item .green { color: #4ade80; }
    .history-item .orange { color: #fb923c; }
    .history-item .purple { color: #c084fc; }
    .history-item .daily {
      border-top: 1px solid #374151;
      padding-top: 8px;
      margin-top: 8px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px;
      font-size: 0.85rem;
    }
    .history-item .notes {
      font-size: 0.75rem;
      color: #9ca3af;
      margin-top: 8px;
    }
    .footer {
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 20px;
    }
    .empty { text-align: center; color: #6b7280; padding: 32px 0; }
    .positive { color: #facc15; }
    .negative { color: #4ade80; }
    .hidden { display: none; }
    .time-ref {
      background: #1f2937;
      border-radius: 8px;
      padding: 8px 10px;
      margin-bottom: 12px;
      font-size: 0.65rem;
      color: #9ca3af;
      line-height: 1.4;
    }
    .time-ref strong { color: #e5e7eb; }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚ö° LADWP Meter</h1>
    <div class="header-buttons">
      <button onclick="toggleSettings()">‚öôÔ∏è</button>
      <button onclick="toggleHistory()">üìä</button>
    </div>
  </div>

  <!-- Settings Panel -->
  <div id="settingsPanel" class="settings-panel hidden">
    <h2>Rate Settings ($/kWh)</h2>
    <div class="rate-grid">
      <div>
        <label>High Peak</label>
        <input type="number" id="rateHigh" step="0.001" value="0.25">
      </div>
      <div>
        <label>Low Peak</label>
        <input type="number" id="rateLow" step="0.001" value="0.18">
      </div>
      <div>
        <label>Base</label>
        <input type="number" id="rateBase" step="0.001" value="0.12">
      </div>
    </div>
    <div class="settings-buttons">
      <button class="save-rates" onclick="saveRates()">Save Rates</button>
      <button class="export" onclick="exportCSV()">Export CSV</button>
    </div>
    <button class="clear-btn" onclick="clearAllData()">Clear All Data</button>
  </div>

  <!-- Entry View -->
  <div id="entryView">
    <!-- Date/Time Picker -->
    <div class="datetime-section">
      <label>üìÖ Reading time:</label>
      <input type="datetime-local" id="readingDateTime">
      <button onclick="setNow()">Now</button>
    </div>

    <div class="time-ref">
      <strong>TOU Periods (Mon-Fri):</strong> High Peak 1-5pm ¬∑ Low Peak 10am-1pm & 5-8pm ¬∑ Base 8pm-10am & weekends
    </div>

    <!-- Delivered Section -->
    <div class="section delivered">
      <h2>üì• DELIVERED (grid ‚Üí you)</h2>
      <div class="input-grid">
        <div class="input-group">
          <label><span class="code">04</span> High Pk</label>
          <input type="number" id="del04" inputmode="numeric" placeholder="0">
        </div>
        <div class="input-group">
          <label><span class="code">10</span> Low Pk</label>
          <input type="number" id="del10" inputmode="numeric" placeholder="0">
        </div>
        <div class="input-group">
          <label><span class="code">16</span> Base</label>
          <input type="number" id="del16" inputmode="numeric" placeholder="0">
        </div>
      </div>
    </div>

    <!-- Received Section -->
    <div class="section received">
      <h2>üì§ RECEIVED (you ‚Üí grid)</h2>
      <div class="input-grid">
        <div class="input-group">
          <label><span class="code">21</span> High Pk</label>
          <input type="number" id="rec21" inputmode="numeric" placeholder="0">
        </div>
        <div class="input-group">
          <label><span class="code">25</span> Low Pk</label>
          <input type="number" id="rec25" inputmode="numeric" placeholder="0">
        </div>
        <div class="input-group">
          <label><span class="code">29</span> Base</label>
          <input type="number" id="rec29" inputmode="numeric" placeholder="0">
        </div>
      </div>
    </div>

    <!-- Net Section -->
    <div class="section net">
      <h2>üìä NET BY PERIOD</h2>
      <div class="input-grid">
        <div class="input-group">
          <label><span class="code">71</span> High Pk</label>
          <input type="number" id="net71" inputmode="numeric" placeholder="0">
        </div>
        <div class="input-group">
          <label><span class="code">72</span> Low Pk</label>
          <input type="number" id="net72" inputmode="numeric" placeholder="0">
        </div>
        <div class="input-group">
          <label><span class="code">73</span> Base</label>
          <input type="number" id="net73" inputmode="numeric" placeholder="0">
        </div>
      </div>
    </div>

    <!-- Totals Section -->
    <div class="section totals">
      <h2>üìà TOTALS</h2>
      <div class="input-grid two-col">
        <div class="input-group">
          <label><span class="code">39</span> Total Del</label>
          <input type="number" id="total39" inputmode="numeric" placeholder="0">
        </div>
        <div class="input-group">
          <label><span class="code">74</span> Net Total</label>
          <input type="number" id="net74" inputmode="numeric" placeholder="0">
        </div>
      </div>
    </div>

    <!-- Notes -->
    <input type="text" class="notes" id="notes" placeholder="Notes (optional)">

    <!-- Save Button -->
    <button class="save-btn" onclick="saveReading()">üíæ Save Reading</button>

    <div class="status" id="status"></div>

    <!-- Validation -->
    <div class="validation" id="validation"></div>
  </div>

  <!-- History View -->
  <div id="historyView" class="hidden">
    <div class="history-panel">
      <h2>Reading History</h2>
      <div id="historyList"></div>
    </div>
  </div>

  <div class="footer" id="footer"></div>

  <script>
    let readings = [];
    let rates = { high: 0.25, low: 0.18, base: 0.12 };

    function init() {
      const savedReadings = localStorage.getItem('ladwp_readings_v2');
      if (savedReadings) readings = JSON.parse(savedReadings);
      
      const savedRates = localStorage.getItem('ladwp_rates');
      if (savedRates) {
        rates = JSON.parse(savedRates);
        document.getElementById('rateHigh').value = rates.high;
        document.getElementById('rateLow').value = rates.low;
        document.getElementById('rateBase').value = rates.base;
      }
      
      setNow();
      updateFooter();
      setupValidation();
    }

    function setNow() {
      const now = new Date();
      const offset = now.getTimezoneOffset();
      const local = new Date(now.getTime() - offset * 60000);
      document.getElementById('readingDateTime').value = local.toISOString().slice(0, 16);
    }

    function setupValidation() {
      const inputs = ['del04', 'del10', 'del16', 'rec21', 'rec25', 'rec29', 'net71', 'net72', 'net73', 'total39', 'net74'];
      inputs.forEach(id => {
        document.getElementById(id).addEventListener('input', validateReadings);
      });
    }

    function validateReadings() {
      const del04 = parseFloat(document.getElementById('del04').value) || 0;
      const del10 = parseFloat(document.getElementById('del10').value) || 0;
      const del16 = parseFloat(document.getElementById('del16').value) || 0;
      const rec21 = parseFloat(document.getElementById('rec21').value) || 0;
      const rec25 = parseFloat(document.getElementById('rec25').value) || 0;
      const rec29 = parseFloat(document.getElementById('rec29').value) || 0;
      const net71 = parseFloat(document.getElementById('net71').value) || 0;
      const net72 = parseFloat(document.getElementById('net72').value) || 0;
      const net73 = parseFloat(document.getElementById('net73').value) || 0;
      const total39 = parseFloat(document.getElementById('total39').value) || 0;
      const net74 = parseFloat(document.getElementById('net74').value) || 0;

      const calc39 = del04 + del10 + del16;
      const calcNet71 = del04 - rec21;
      const calcNet72 = del10 - rec25;
      const calcNet73 = del16 - rec29;
      const calc74 = net71 + net72 + net73;

      let html = '<div style="font-weight:bold;margin-bottom:6px;">Validation Checks:</div>';
      
      if (total39 > 0) {
        const match39 = Math.abs(total39 - calc39) < 1;
        html += `<div class="row"><span>39 = 04+10+16 (${calc39.toFixed(0)})</span><span class="${match39 ? 'pass' : 'fail'}">${match39 ? '‚úì' : '‚úó ' + total39}</span></div>`;
      }
      
      if (net71 !== 0 || del04 > 0 || rec21 > 0) {
        const match71 = Math.abs(net71 - calcNet71) < 1;
        html += `<div class="row"><span>71 = 04-21 (${calcNet71.toFixed(0)})</span><span class="${match71 ? 'pass' : 'fail'}">${match71 ? '‚úì' : '‚úó ' + net71}</span></div>`;
      }
      
      if (net72 !== 0 || del10 > 0 || rec25 > 0) {
        const match72 = Math.abs(net72 - calcNet72) < 1;
        html += `<div class="row"><span>72 = 10-25 (${calcNet72.toFixed(0)})</span><span class="${match72 ? 'pass' : 'fail'}">${match72 ? '‚úì' : '‚úó ' + net72}</span></div>`;
      }
      
      if (net73 !== 0 || del16 > 0 || rec29 > 0) {
        const match73 = Math.abs(net73 - calcNet73) < 1;
        html += `<div class="row"><span>73 = 16-29 (${calcNet73.toFixed(0)})</span><span class="${match73 ? 'pass' : 'fail'}">${match73 ? '‚úì' : '‚úó ' + net73}</span></div>`;
      }
      
      if (net74 !== 0) {
        const match74 = Math.abs(net74 - calc74) < 1;
        html += `<div class="row"><span>74 = 71+72+73 (${calc74.toFixed(0)})</span><span class="${match74 ? 'pass' : 'fail'}">${match74 ? '‚úì' : '‚úó ' + net74}</span></div>`;
      }

      document.getElementById('validation').innerHTML = html;
    }

    function toggleSettings() {
      document.getElementById('settingsPanel').classList.toggle('hidden');
    }

    function toggleHistory() {
      const historyView = document.getElementById('historyView');
      const entryView = document.getElementById('entryView');
      const isHidden = historyView.classList.contains('hidden');
      
      if (isHidden) {
        historyView.classList.remove('hidden');
        entryView.classList.add('hidden');
        renderHistory();
      } else {
        historyView.classList.add('hidden');
        entryView.classList.remove('hidden');
      }
    }

    function saveReading() {
      const del04 = document.getElementById('del04').value;
      const del10 = document.getElementById('del10').value;
      const del16 = document.getElementById('del16').value;
      
      if (!del04 && !del10 && !del16) {
        showStatus('Please enter at least one delivered reading');
        return;
      }

      const dateTimeValue = document.getElementById('readingDateTime').value;
      const timestamp = dateTimeValue ? new Date(dateTimeValue).toISOString() : new Date().toISOString();

      const reading = {
        id: Date.now(),
        timestamp: timestamp,
        del04: del04 || '',
        del10: del10 || '',
        del16: del16 || '',
        rec21: document.getElementById('rec21').value || '',
        rec25: document.getElementById('rec25').value || '',
        rec29: document.getElementById('rec29').value || '',
        net71: document.getElementById('net71').value || '',
        net72: document.getElementById('net72').value || '',
        net73: document.getElementById('net73').value || '',
        total39: document.getElementById('total39').value || '',
        net74: document.getElementById('net74').value || '',
        notes: document.getElementById('notes').value || ''
      };

      readings.push(reading);
      // Sort by timestamp to keep readings in chronological order
      readings.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      localStorage.setItem('ladwp_readings_v2', JSON.stringify(readings));

      // Clear form
      ['del04', 'del10', 'del16', 'rec21', 'rec25', 'rec29', 'net71', 'net72', 'net73', 'total39', 'net74', 'notes'].forEach(id => {
        document.getElementById(id).value = '';
      });

      setNow();
      showStatus('‚úì Saved!');
      updateFooter();
      document.getElementById('validation').innerHTML = '';
    }

    function showStatus(msg) {
      const status = document.getElementById('status');
      status.textContent = msg;
      setTimeout(() => status.textContent = '', 2500);
    }

    function updateFooter() {
      document.getElementById('footer').textContent = 
        `${readings.length} reading${readings.length !== 1 ? 's' : ''} saved`;
    }

    function calculateDaily(current, previous) {
      if (!previous) return null;

      const delivered = {
        high: (parseFloat(current.del04) || 0) - (parseFloat(previous.del04) || 0),
        low: (parseFloat(current.del10) || 0) - (parseFloat(previous.del10) || 0),
        base: (parseFloat(current.del16) || 0) - (parseFloat(previous.del16) || 0)
      };

      const received = {
        high: (parseFloat(current.rec21) || 0) - (parseFloat(previous.rec21) || 0),
        low: (parseFloat(current.rec25) || 0) - (parseFloat(previous.rec25) || 0),
        base: (parseFloat(current.rec29) || 0) - (parseFloat(previous.rec29) || 0)
      };

      const totalDel = delivered.high + delivered.low + delivered.base;
      const totalRec = received.high + received.low + received.base;
      const net = totalDel - totalRec;

      const cost = (delivered.high * rates.high + delivered.low * rates.low + delivered.base * rates.base)
                 - (received.high * rates.high + received.low * rates.low + received.base * rates.base);

      return { delivered, received, totalDel, totalRec, net, cost };
    }

    function renderHistory() {
      const container = document.getElementById('historyList');
      
      if (readings.length === 0) {
        container.innerHTML = '<div class="empty">No readings yet</div>';
        return;
      }

      let html = '';
      for (let i = readings.length - 1; i >= 0; i--) {
        const r = readings[i];
        const prev = i > 0 ? readings[i - 1] : null;
        const daily = calculateDaily(r, prev);
        const date = new Date(r.timestamp);

        html += `
          <div class="history-item">
            <div class="date-row">
              <div>
                <div class="date">${date.toLocaleDateString()}</div>
                <div class="time">${date.toLocaleTimeString()}</div>
              </div>
              <button class="delete-btn" onclick="deleteReading(${r.id})">‚úï</button>
            </div>
            <div class="codes-grid">
              <div>
                <div class="label">Delivered (04/10/16)</div>
                <div class="blue">${r.del04 || '-'} / ${r.del10 || '-'} / ${r.del16 || '-'}</div>
              </div>
              <div>
                <div class="label">Received (21/25/29)</div>
                <div class="green">${r.rec21 || '-'} / ${r.rec25 || '-'} / ${r.rec29 || '-'}</div>
              </div>
              <div>
                <div class="label">Net (71/72/73)</div>
                <div class="orange">${r.net71 || '-'} / ${r.net72 || '-'} / ${r.net73 || '-'}</div>
              </div>
              <div>
                <div class="label">Totals (39 / 74)</div>
                <div class="purple">${r.total39 || '-'} / ${r.net74 || '-'}</div>
              </div>
            </div>

            ${daily ? `
              <div class="daily">
                <div>Œî Delivered: <span class="blue">${daily.totalDel.toFixed(1)}</span> kWh</div>
                <div>Œî Received: <span class="green">${daily.totalRec.toFixed(1)}</span> kWh</div>
                <div>Œî Net: <span class="${daily.net < 0 ? 'negative' : 'positive'}">${daily.net.toFixed(1)}</span> kWh</div>
                <div>Œî Cost: <span class="${daily.cost < 0 ? 'negative' : 'positive'}">$${daily.cost.toFixed(2)}</span></div>
              </div>
            ` : ''}

            ${r.notes ? `<div class="notes">üìù ${r.notes}</div>` : ''}
          </div>
        `;
      }
      container.innerHTML = html;
    }

    function deleteReading(id) {
      readings = readings.filter(r => r.id !== id);
      localStorage.setItem('ladwp_readings_v2', JSON.stringify(readings));
      renderHistory();
      updateFooter();
    }

    function saveRates() {
      rates = {
        high: parseFloat(document.getElementById('rateHigh').value) || 0,
        low: parseFloat(document.getElementById('rateLow').value) || 0,
        base: parseFloat(document.getElementById('rateBase').value) || 0
      };
      localStorage.setItem('ladwp_rates', JSON.stringify(rates));
      showStatus('‚úì Rates saved!');
    }

    function exportCSV() {
      let csv = 'Date,Time,Del_04,Del_10,Del_16,Rec_21,Rec_25,Rec_29,Net_71,Net_72,Net_73,Total_39,Net_74,Notes\n';
      readings.forEach(r => {
        const d = new Date(r.timestamp);
        csv += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${r.del04},${r.del10},${r.del16},${r.rec21},${r.rec25},${r.rec29},${r.net71},${r.net72},${r.net73},${r.total39},${r.net74},"${r.notes}"\n`;
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'ladwp_readings.csv';
      a.click();
    }

    function clearAllData() {
      if (confirm('Delete all readings? This cannot be undone.')) {
        readings = [];
        localStorage.removeItem('ladwp_readings_v2');
        updateFooter();
        renderHistory();
        showStatus('All data cleared');
      }
    }

    init();
  </script>
</body>
</html>
